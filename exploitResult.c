#include <stdio.h>
#include <stdlib.h>
#include "graph.h"
#include "pageRank.h"

void triFusion(int i, int j, int* id, int* tmp, double* value, double* tmpValue){
	
	if(j <= i){
		return;
	}
  
    int m = (i + j) / 2;
    
    //Tri de la partie gauche
    triFusion(i, m, id, tmp, value, tmpValue);     
    
    //Tri de la partie droite
    triFusion(m + 1, j, id, tmp, value, tmpValue); 
    
    int pg = i;     
    int pd = m + 1; 
    int c;          
    
    //On remplit nos tableaux finaux (tmp et tmpValue)
	for(c = i; c <= j; c++) {
		
		if(pg == m + 1) { 
			
			tmpValue[c] = value[pd];
			tmp[c] = id[pd];
			pd++;
			
		}else if (pd == j + 1) { 
			
			tmpValue[c] = value[pg];
			tmp[c] = id[pg];
			pg++;
			
		}else if (value[pg] > value[pd]) {
			 
			tmpValue[c] = value[pg]; 
			tmp[c] = id[pg];
			pg++;
			
		}else { 
			
			tmpValue[c] = value[pd]; 
			tmp[c] = id[pd];
			pd++;
			
		}
	}
	
	//On copie les éléments des tableaux tmp et tmpValue dans leur tableaux originaux	
    for(c = i; c <= j; c++) {
		value[c] = tmpValue[c];
        id[c] = tmp[c];
    }
}

void sort_and_print(Graph* g){
	
	int i;
	int* id;
	int* tmp;
	double* value;
	double* tmpValue;
	
	id=(int*)malloc(g->nbPages * sizeof(int));
	value=(double*)malloc(g->nbPages * sizeof(double));
	tmp=(int*)malloc(g->nbPages * sizeof(int));
	tmpValue=(double*)malloc(g->nbPages * sizeof(double));
	
	for(i=0;i<g->nbPages;i++){
		id[i] = i;
		value[i] = g->value[i];
	}
	
	//Tri fusion sur nos données (on tri par ordre décroissant par rapport à value)
	triFusion(0,g->nbPages-1,id,tmp,value,tmpValue);

    FILE* file = NULL;
	file = fopen("Result_Sorted.txt", "w+");
	
	if (file==NULL){
		fprintf(stderr, "Erreur : Probleme à l'ouverture du fichier.\n");
		exit(EXIT_FAILURE);
    }
	
	//Pour toutes les pages
	for(i=0;i<g->nbPages;i++){
		
		//On écrit l'identifiant de la page et la chance de se trouver sur cette dernière
		fprintf(file,"%d \t %.15f\n",id[i],value[i]);
	}
	fclose(file);
	
	printf("Fichier Result_Sorted.txt mis à jour.\n");
	
	
    free(id);
    free(value);
    free(tmp);
    free(tmpValue);
}
